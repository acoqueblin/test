---
title: "Prix des boites de LEGO"
author: "A. Coqueblin"
date: "26 décembre 2016"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
	echo = FALSE,
	fig.height = 7,
	fig.width = 10,
	message = FALSE,
	warning = FALSE
)
# Set figure dimensions
opts_chunk$set(fig.width=10, fig.height=7)
# opts_knit$set(upload.fun = function(file){library(RWordPress);uploadFile(file)$url;})
load('lego_all.RData')
source("essai pentes.R")
lego_all <- as.data.frame(lego_all)
```

```{r}
library(lattice)
library(ggplot2)
library(gridExtra)
library(GGally)
library(data.table)
```

Noël est passé et le gros bonhomme rouge a déposé des LEGO sous le sapin. C'est l'occasion pour R de reprendre du service après les fêtes, pour tenter de comprendre ce qui dicte le prix des LEGO.

# Récupérer les données

Pour commencer, il faut constituer une base de données sur les caractéristiques des boites de LEGO actuellement en vente. Pour ce faire, j'ai utilisé l'excellent package *rvest*. Vous trouverez le script  [ici](https://arnaudcoqueblin.files.wordpress.com/2016/05/tous_les_lego.pdf). Il est certainement possible de le rendre plus efficient et vos remarques sont les bienvenues !

Les données telles que le thème, le numéro de référence, le prix, le nombre de pièces dans une boite, et l'âge recommandé, sont issues du site <https://shop.lego.com/>.
Celles concernant le nombre de figurines présentes dans chaque boite et l'année de sortie sont issues du site <http://fr.bricker.info/>.

# Analyser les données

Voici un aperçu des données collectées :
```{r lego_all, echo=TRUE}
knitr::kable(head(as.data.frame(lego_all)[,c(1:3,5:7)]))
```

Il ne reste plus qu'à les examiner de plus près...

## Passons à la caisse

Dans la gamme LEGO, les prix s'étalent de quelques euros à plusieurs centaines d'euros. La majorité des boites restent cependant abordables, avec un prix médian aux alentours de 30€.
La distribution des prix est asymétrique et peut-être même bi-modale, si l'on en juge par le deuxième pic aux alentours des 100€.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
summary(lego_all$prix)
p1 <- ggplot(lego_all, aes("",prix)) + geom_boxplot( fill="red", alpha=0.3) + coord_flip() + xlab("") +
    stat_summary(fun.y=fivenum, geom="label", vjust=2:6, aes( label=round(..y..,1)), fill="dodgerblue")
p2 <- ggplot(lego_all, aes(prix))  + geom_histogram(aes(y=..density..), fill="gray70") + geom_density(fill="red", alpha=0.3)
grid.arrange(p1,p2)
```

 + Un début d'explication...?

Les boites de LEGO comptent actuellement 28 thèmes.
Les gammes de prix sont assez homogènes entre les thèmes, bien que les prix s'envolent pour certains, du fait notamment du tarif des boites **SERIOUS PLAY**, de l'Etoile de le Mort de **Star Wars** et du QG **Ghostbusters** (les **SERIOUS PLAY** s'adressant plutôt au monde du travail tandis que les autres sont des franchises peut-être destinées plutôt aux quadra nostalgiques et fortunés...). Personnellement, je m'attendais à ce que les LEGO Technic soient les plus chers.

```{r, echo=TRUE}
ggplot(lego_all, aes(Theme, prix, fill=Theme)) + geom_boxplot() + 
  theme(legend.position="none", axis.text.x  = element_text(angle=90, vjust=0.5)) +
  ggtitle("Prix des boites de LEGO", subtitle="(les prix sont en euros)")
```

En parlant de franchises, elles ne sont bizarrement pas toutes logées à la même enseigne. **Angry Birds**, **DC Comics**, **Disney** et quelques autres restent sous la barre des 100€. 
Les franchises plus *vintage*, comme **Ghostbusters**, **Star Wars**, **Le Seigneur des Anneaux** et **Les Simpsons** ont des amplitudes de tarif plus importantes. Du point de vue marketing, on pourrait être tenté de les classer dans la catégorie "Vache à lait" d'une matrice BCG... Mais pour être tout à fait honnête, on peut trouver d'autres explications à ces tarifs élevés. Les franchises **Ghostbusters**, **Star wars** et **Les Simpsons** se caractérisent par quelques très grosses boites et les boites estampillées **Le Seigneur des Anneaux** sont principalement des boitiers à connecter aux consoles de jeu.

## Il est temps de déballer la boite...

Regardons maintenant les relations potentielles entre les différentes caractristiques des boites, à l'aide d'une matrice de nuages de points.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
GGally::ggpairs(lego_all[,c(1,6,8:11,5)] , columns = 2:7)
```

La corrélation la plus forte (0.813) concerne le prix et le nombre de pièces par boite. La complexité des modèles et le poids d'[ABS](https://fr.wikipedia.org/wiki/Acrylonitrile_butadiène_styrène) (Acrylonitrile Butadiène Styrène), qui compose les briques de LEGO, semblent être les principaux facteurs pouvant expliquer le tarif. Je n'ai pas pu récupérer de données sur le poids des pièces, mais on peut s'attendre à ce qu'il soit assez bien corrélé avec le nombre de pièces, à l'exception peut-être des **Duplo** qui sont composés de gros blocs.
Une corrélation plus faible (0.61) existe aussi entre le nombre de pièces et l'âge minimum recommandé. Les petits auraient moins de patience que les grands enfants...

Il existe donc une assez belle relation linéaire entre le prix et le nombre de pièces, mais certaines boites s'écartent fortement de la tendance générale. 

```{r, echo=TRUE}
ggplot(lego_all, aes(pieces,prix, colour=Theme)) + geom_point() + 
  ggtitle("Prix des boites de LEGO", subtitle="(les prix sont en euros)")
```

En traçant uniquement de simples droites de régression avec les mêmes données, on peut voir un faisceau de droites dont la pente donne grossièrement la relation suivante : 10 pièces de LEGO coûtent 1€. Ceci dit, cette relation n'est pas vraie partout :

+ deux droites de couleur marron ont des pentes plus faibles (thèmes **Classic** et **Creator**, qui sont plus économiques).
+ la droite violette au-dessus de la mêlée est atypique. Elle correspond au thème **SERIOUS PLAY**, apparemment destinée aux serious games en milieu professionnel. 
+ la droite bleue à gauche, avec une très forte pente correspond au thème **MINDSTORMS**. Des boites un peu chères sur le thème de la robotique et comportant le plus souvent un seul élément.

```{r, echo=TRUE}
ggplot(lego_all, aes(pieces,prix, colour=Theme)) + geom_point(alpha=0.5) + 
  geom_smooth(method=lm, size=1, se = FALSE) + ggtitle("Prix des boites de LEGO", subtitle="(les prix sont en euros)") 
```

En y regardant de plus près, il n'est pas judicieux de tracer une droite de régression pour les boites **SERIOUS PLAY**, tellement les données sont éparpillées. Les deux points sous la droite de régression sont à peu près en phase avec la tendance générale, mais les deux points les plus élevés correspondent aux boites les plus chères de toute la collection LEGO. En plus du "prix au kilo", on peut supposer qu'elles bénéficient d'un ticket d'entrée plus élevé, étant donné qu'elles s'adressent au milieu professionnel.

```{r, echo=TRUE}
ggplot(lego_all[lego_all$Theme %in% c("Classic","Creator","MINDSTORMS®","SERIOUS PLAY®","DUPLO®"),], aes(pieces,prix, colour=Theme)) + geom_point() + geom_smooth(method=lm, size=1, se = FALSE) + ggtitle("Prix des boites de LEGO") + facet_wrap(~Theme)
```

# En résumé

En faisant abstraction des éléments électroniques vendus par LEGO, le prix des boites s'explique donc surtout par le nombre de pièces et par le thème. A quelques rares exceptions près, les droites sont bien ajustées aux données.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
lego.se <- subset(lego_all,  electr=="non")
ggplot(lego.se, aes(pieces,prix, colour=Theme)) + geom_point() +
  geom_smooth(method=MASS::rlm, size=1, se = FALSE) + facet_wrap(~Theme, scales="free") +
  ggtitle("Prix des boites de LEGO", subtitle="(les prix sont en euros)") 
```

Les pentes de ces droites sont en moyenne de 10% (10€ pour 100 pièces de LEGO). 

```{r, echo=TRUE}
pentes.par.theme <- setDT(lego_all)[electr=="non", as.list(calc.pentes(pieces,prix)), by = Theme]
names(pentes.par.theme)[2:3] <- c("ord.orig","pente")
summary(pentes.par.theme$pente)
```
La plus forte pente est celle des **Duplo**, mais comme évoqué plus haut, ces boites contiennent de grosses pièces par rapport aux briques des autres boites. Ceci renforce aussi l'idée que le prix des LEGO serait aussi lié au poids d'ABS qui les compose, le "prix au kilo" en somme.
```{r, echo=TRUE}
ggplot(pentes.par.theme,aes(Theme,pente)) + geom_col(fill="steelblue") + 
  theme(legend.position="none", axis.text.x  = element_text(angle=90, vjust=0.5)) +
  ggtitle("Pentes par thème")
```